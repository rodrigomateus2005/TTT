var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var C_NFSe = /** @class */ (function (_super) {
    __extends(C_NFSe, _super);
    function C_NFSe() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(C_NFSe.prototype, "cboEmpresa", {
        get: function () {
            return window['cboEmpresa_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "cboLocalOperacao", {
        get: function () {
            return window['cboLocalOperacao_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "lblForaMun", {
        get: function () {
            return window['lblForaMun_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtCodigoCliente", {
        get: function () {
            return window['txtCodigoCliente_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "chkISSRetido", {
        get: function () {
            return window['chkISSRetido_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtCidadeOperacao", {
        get: function () {
            return window['txtCidadeOperacao_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtCodServico", {
        get: function () {
            return window['txtCodServico_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtNomeCliente", {
        get: function () {
            return window['txtNomeCliente_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtRg", {
        get: function () {
            return window['txtRg_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtCpf", {
        get: function () {
            return window['txtCpf_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtCidade", {
        get: function () {
            return window['txtCidade_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtTelefone", {
        get: function () {
            return window['txtTelefone_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtEndereco", {
        get: function () {
            return window['txtEndereco_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtNumero", {
        get: function () {
            return window['txtNumero_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtComplemento", {
        get: function () {
            return window['txtComplemento_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtBairro", {
        get: function () {
            return window['txtBairro_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtCep", {
        get: function () {
            return window['txtCep_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtValAproxTrib", {
        get: function () {
            return window['txtValAproxTrib_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtValor", {
        get: function () {
            return window['txtValor_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "cboTipoTomador", {
        get: function () {
            return window['cboTipoTomador_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "cboServico", {
        get: function () {
            return window['cboServico_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "txtNumeronfse", {
        get: function () {
            return window['txtNumeronfse_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "hdnCodigo", {
        get: function () {
            return $('#hdnCodigo')[0];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "hdnSeriePadrao", {
        get: function () {
            return $('#hdnSeriePadrao')[0];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "hdnCaminhoXML", {
        get: function () {
            return $('#hdnCaminhoXML')[0];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "hdnEmpresa", {
        get: function () {
            return $('#hdnEmpresa')[0];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "btnMais", {
        get: function () {
            return window['btnMais_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "btnMenos", {
        get: function () {
            return window['btnMenos_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "btnTransmitir", {
        get: function () {
            return window['btnTransmitir_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "btnGerarXml", {
        get: function () {
            return window['btnGerarXml_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "btnAssinar", {
        get: function () {
            return window['btnAssinar_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "btnConsultarNfse", {
        get: function () {
            return window['btnConsultarNfse_Object'];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(C_NFSe.prototype, "RetNFSe", {
        get: function () {
            if (!this.GetScope()["RetNFSe"]) {
                this.GetScope()["RetNFSe"] = {};
            }
            return this.GetScope()["RetNFSe"];
        },
        set: function (value) {
            this.GetScope()["RetNFSe"] = value;
        },
        enumerable: true,
        configurable: true
    });
    C_NFSe.prototype.Init = function () {
        _super.prototype.Init.call(this);
        //if (this.cboServico) {
        //    adicionarEventoMoura(this.cboServico.SelectedItemChanged, this.PreencherCamposProcuraServico, this);
        //}
        if (this.txtCodServico) {
            adicionarEventoMoura(this.txtCodServico.Procurou, this.OnPesquisouCodigoServico, this);
        }
        if (this.chkISSRetido) {
            adicionarEventoMoura(this.chkISSRetido.CheckChanged, this.chkISSRetidoCheckChanged, this);
        }
        if (this.cboLocalOperacao) {
            adicionarEventoMoura(this.cboLocalOperacao.SelectedItemChanged, this.OncboLocalOperacaoIndexChanged, this);
        }
        if (this.btnGerarXml) {
            adicionarEventoMoura(this.btnGerarXml.Click, this.OnClickBotaoGerarXML, this);
        }
        if (this.btnTransmitir) {
            adicionarEventoMoura(this.btnTransmitir.Click, this.OnClickBotaoGerenciarNFSe, this);
        }
        if (this.btnAssinar) {
            adicionarEventoMoura(this.btnAssinar.Click, this.OnClickBotaoAssinarXML, this);
        }
        if (this.btnConsultarNfse) {
            adicionarEventoMoura(this.btnConsultarNfse.Click, this.OnClickBotaoConsultar, this);
        }
    };
    C_NFSe.prototype.OnClickBotaoGerenciarNFSe = function (s, e) {
        e.processOnServer = false;
        var parametros;
        parametros = {
            codigo: this.EntityTela.Numerorps,
            empresa: this.EntityTela.Empresa,
            serie: this.EntityTela.Serie
        };
        retorno = this.ExecutarFuncaoServerSideSynch("ObterNumeroRps", parametros);
        if (retorno == null) {
            MostrarAlerta("Para acessar as opções de gerenciamento de NFS-e é necessário que a Nota Fiscal esteja gravada!");
            return;
        }
        var retorno;
        var entity = this.GetScope().Entity;
        parametros = {
            codigoNfse: entity.Codigo
        };
        retorno = this.ExecutarFuncaoServerSideSynch("RetornaSituacao", parametros);
        var arrRetorno = retorno.split("|");
        if (arrRetorno[0].toString() != "Erro") {
            var EntidadeRetorno = this.RetNFSe;
            EntidadeRetorno.SituacaoAtual = arrRetorno[0].toString();
            EntidadeRetorno.MensagemRetorno = arrRetorno[1].toString();
            this.RetNFSe = EntidadeRetorno;
            this.RefreshAngular();
        }
        return false;
    };
    C_NFSe.prototype.OnConsultar = function () {
        var entity = this.GetScope().Entity;
        if ((entity.Numeronfse == 0) && (entity.Protocolo == null || entity.Protocolo == "0") && entity.Codverificacaonfse == null) {
            MostrarError("Essa NFS-e ainda não foi enviada, portanto ainda não pode ser consultada!");
        }
    };
    C_NFSe.prototype.OnClickBotaoConsultar = function (s, e) {
        e.processOnServer = false;
        var parametros;
        var retorno;
        abrirEspera();
        parametros = {
            codigoNf: this.hdnCodigo.value,
            codEmpresa: this.hdnEmpresa.value
        };
        retorno = this.ExecutarFuncaoServerSideSynch("ConsultaNFChave", parametros);
        var arrRetorno = retorno.split("|");
        if (arrRetorno[0].toString() == "Erro") {
            if (arrRetorno[1].toString() != "Nenhum certificado foi configurado para esta empresa!") {
            }
            this.RetNFSe.MensagemRetorno = arrRetorno[1].toString();
        }
        else {
            this.RetNFSe.MensagemRetorno = arrRetorno[1].toString();
        }
        MsgBoxJS(arrRetorno[1].toString(), MsgBoxOptions.OkOnly, MsgBoxIcon.Info, $.proxy(null, this));
        fecharEspera();
        this.RefreshAngular();
        return false;
    };
    C_NFSe.prototype.OnClickBotaoGerarXML = function (s, e) {
        e.processOnServer = false;
        var parametros;
        var retorno;
        var entity = this.GetScope().Entity;
        if (entity.Numeronfse != null) {
            this.OnConsultar();
        }
        parametros = {
            codigoNf: entity.Codigo,
            caminhoXML: this.hdnCaminhoXML.value,
            codEmpresa: entity.Empresa
        };
        retorno = this.ExecutarFuncaoServerSideSynch("GerarNFe", parametros);
        var arrRetorno = retorno.split("|");
        var EntidadeRetorno = this.RetNFSe;
        if (arrRetorno[0].toString() == "Erro") {
            MsgBoxJS(arrRetorno[1].toString(), MsgBoxOptions.OkOnly, MsgBoxIcon.Info, $.proxy(null, this));
            EntidadeRetorno.MensagemRetorno = arrRetorno[1].toString();
        }
        else {
            EntidadeRetorno.MensagemRetorno = arrRetorno[1].toString();
        }
        this.RetNFSe = EntidadeRetorno;
        this.GetScope().$apply();
        return false;
    };
    C_NFSe.prototype.OnClickBotaoAssinarXML = function (s, e) {
        e.processOnServer = false;
        var parametros;
        var retorno;
        var entity = this.GetScope().Entity;
        if (entity.Numeronfse != null) {
            if (entity.Numeronfse > 0) {
                MostrarAlerta("NFS-e já foi autorizada");
                return false;
            }
        }
        parametros = {
            codigoNfse: entity.Codigo,
            codEmpresa: entity.Empresa
        };
        retorno = this.ExecutarFuncaoServerSideSynch("AssinarNFSe", parametros);
        var arrRetorno = retorno.split("|");
        var EntidadeRetorno = this.RetNFSe;
        if (arrRetorno[0].toString() == "Erro") {
            MsgBoxJS(arrRetorno[1].toString(), MsgBoxOptions.OkOnly, MsgBoxIcon.Info, $.proxy(null, this));
            EntidadeRetorno.MensagemRetorno = arrRetorno[1].toString();
        }
        else {
            EntidadeRetorno.SituacaoAtual = "Assinada";
            //this.NFSe.Situacao = "Assinada";
            EntidadeRetorno.MensagemRetorno = arrRetorno[1].toString();
            EntidadeRetorno.CodCertificado = arrRetorno[2];
        }
        this.RetNFSe = EntidadeRetorno;
        this.RefreshAngular();
        return false;
    };
    C_NFSe.prototype.OnPageLoad = function () {
        _super.prototype.OnPageLoad.call(this);
        if (!this.GetScope().OnPesquisarDescricaoCodServico) {
            this.GetScope().OnPesquisarDescricaoCodServico = $.proxy(this.OnPesquisarDescricaoCodServico, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Codservico; }, this.GetScope().OnPesquisarDescricaoCodServico);
        }
        if (!this.GetScope().onMudouComboEmpresa) {
            this.GetScope().onMudouComboEmpresa = $.proxy(this.OnMudouComboEmpresa, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Empresa; }, this.GetScope().onMudouComboEmpresa);
        }
        if (!this.GetScope().OnMudouComboSerie) {
            this.GetScope().OnMudouComboSerie = $.proxy(this.OnMudouComboSerie, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Serie; }, this.GetScope().OnMudouComboSerie);
        }
        if (!this.GetScope().OnDigitouNumerorps) {
            this.GetScope().OnDigitouNumerorps = $.proxy(this.OnDigitouNumerorps, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Numerorps; }, this.GetScope().OnDigitouNumerorps);
        }
        //DADOS TOMADOR
        if (!this.GetScope().OnPesquisouDados) {
            this.GetScope().OnPesquisouDados = $.proxy(this.OnPesquisouDados, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Codigocliente; }, this.GetScope().OnPesquisouDados);
        }
        //VALORES
        if (!this.GetScope().OnValorValidar) {
            this.GetScope().OnValorValidar = $.proxy(this.OnValorValidar, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Valor; }, this.GetScope().OnValorValidar);
        }
        if (!this.GetScope().OnValorDeducaoValidar) {
            this.GetScope().OnValorDeducaoValidar = $.proxy(this.OnValorDeducaoValidar, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Valordeducao; }, this.GetScope().OnValorDeducaoValidar);
        }
        if (!this.GetScope().OnDescIncondicionado) {
            this.GetScope().OnDescIncondicionado = $.proxy(this.OnDescIncondicionado, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Descincondicionado; }, this.GetScope().OnDescIncondicionado);
        }
        if (!this.GetScope().OnDescCondicionado) {
            this.GetScope().OnDescCondicionado = $.proxy(this.OnDescCondicionado, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Desccondicionado; }, this.GetScope().OnDescCondicionado);
        }
        if (!this.GetScope().OnOutrasRetencoes) {
            this.GetScope().OnOutrasRetencoes = $.proxy(this.OnOutrasRetencoes, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Outrasretencoes; }, this.GetScope().OnOutrasRetencoes);
        }
        //IMPOSTOS
        if (!this.GetScope().OnValorISSRetido) {
            this.GetScope().OnValorISSRetido = $.proxy(this.OnValorISSRetido, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Valorissretido; }, this.GetScope().OnValorISSRetido);
        }
        if (!this.GetScope().OnPis) {
            this.GetScope().OnPis = $.proxy(this.OnPis, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Pis; }, this.GetScope().OnPis);
        }
        if (!this.GetScope().OnCofins) {
            this.GetScope().OnCofins = $.proxy(this.OnCofins, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Cofins; }, this.GetScope().OnCofins);
        }
        if (!this.GetScope().OnIR) {
            this.GetScope().OnIR = $.proxy(this.OnIR, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Ir; }, this.GetScope().OnIR);
        }
        if (!this.GetScope().OnINSS) {
            this.GetScope().OnINSS = $.proxy(this.OnINSS, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Inss; }, this.GetScope().OnINSS);
        }
        if (!this.GetScope().OnCSLL) {
            this.GetScope().OnCSLL = $.proxy(this.OnCSLL, this);
            this.GetScope().$watch(function (scope) { return scope.Entity.Csll; }, this.GetScope().OnCSLL);
        }
    };
    C_NFSe.prototype.OnPesquisarDescricaoCodServico = function () {
        var parametros;
        var entidade = this.GetScope().Entity;
        if (entidade.Codservico) {
            parametros = {
                descricao: entidade.Codservico
            };
            var descricao = this.ExecutarFuncaoServerSideSynch("RetornarCodigoPorDescricaoServico", parametros);
            if (descricao) {
                this.txtCodServico.Procurar("" + descricao[0].Id);
            }
        }
        this.RefreshAngular();
    };
    C_NFSe.prototype.chkISSRetidoCheckChanged = function () {
        var entity = this.GetScope().Entity;
        if (this.chkISSRetido.Check) {
            entity.Valorissretido = entity.Basecalculo * (entity.Aliquotaservico / 100) + 0;
            entity.Isspagar = entity.Valorissretido;
            entity.Valorliquido = entity.Valorliquido - entity.Isspagar + 0;
        }
        else {
            entity.Valorliquido = entity.Valorliquido + entity.Isspagar + 0;
            entity.Valorissretido = 0;
            entity.Isspagar = 0;
        }
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularBase = function () {
        var entity = this.GetScope().Entity;
        //Está de acordo com o manual da ABRASF no campo BaseCalculo
        var base;
        base = entity.Valor - entity.Valordeducao - entity.Descincondicionado;
        entity.Basecalculo = base;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularPis = function (s) {
        var Pis;
        var entity = this.GetScope().Entity;
        Pis = entity.Basecalculo * (s.Pis / 100);
        entity.Pis = Pis;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularCofins = function (s) {
        var entity = this.GetScope().Entity;
        var Cofins;
        Cofins = entity.Basecalculo * (s.Cofins / 100);
        entity.Cofins = Cofins;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularIr = function (s) {
        var entity = this.GetScope().Entity;
        var Ir;
        Ir = entity.Basecalculo * (s.Ir / 100);
        entity.Ir = Ir;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularInss = function (s) {
        var entity = this.GetScope().Entity;
        var Inss;
        Inss = entity.Basecalculo * (s.Inss / 100);
        entity.Inss = Inss;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularCsll = function (s) {
        var entity = this.GetScope().Entity;
        var Csll;
        Csll = entity.Basecalculo * (s.Csll / 100);
        entity.Csll = Csll;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularIssPagar = function (s) {
        var entity = this.GetScope().Entity;
        if (this.chkISSRetido.Checked) {
            var ISS;
            ISS = entity.Basecalculo * (s.Aliquota / 100);
            entity.Isspagar = ISS;
        }
        else {
            entity.Isspagar = 0;
        }
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.CalcularValorLiquido = function () {
        //Está de acordo com o manual da ABRASF no campo ValorLiquidoNfse
        var valorLiquido;
        var entity = this.GetScope().Entity;
        valorLiquido = entity.Valor - entity.Pis - entity.Cofins;
        valorLiquido = valorLiquido - entity.Inss - entity.Ir - entity.Csll;
        valorLiquido = valorLiquido - entity.Outrasretencoes - entity.Valorissretido;
        valorLiquido = valorLiquido - entity.Descincondicionado - entity.Desccondicionado;
        entity.Valorliquido = valorLiquido;
        this.SetEntity(entity);
        this.RefreshAngular();
    };
    C_NFSe.prototype.OnValorValidar = function () {
        var parametros;
        var parametros2;
        this.hdnEmpresa.value = this.EntityTela.Empresa.toString();
        var entity = this.GetScope().Entity;
        //Dim s As ServicoEmpresa = (New ServicoEmpresaBO).RetornarServicoPorCodigo(Val(cboServico.SelectedValue))
        parametros = {
            descricao: this.cboServico.GetValue()
        };
        var descricao = this.ExecutarFuncaoServerSideSynch("RetornarCodigoPorDescricaoServico", parametros);
        if (descricao) {
            parametros2 = {
                codigo: descricao[0].Id
            };
            var s = this.ExecutarFuncaoServerSideSynch("RetornarServicoPorCodigo", parametros2);
        }
        parametros = {
            codEmpresa: this.hdnEmpresa.value.CNum()
        };
        var empresa = this.ExecutarFuncaoServerSideSynch("PesquisarEmpresaPorCodigo", parametros);
        this.CalcularBase();
        //verificar como implementar essa parte
        //if VerificarCNPJMoura(empresa) = True{
        if (entity.Valor < 215.06) {
            this.CalcularIssPagar(s);
        }
        else if (entity.Valor < 666.67) {
            this.CalcularPis(s);
            this.CalcularCofins(s);
            this.CalcularCsll(s);
            this.CalcularIssPagar(s);
        }
        else {
            this.CalcularPis(s);
            this.CalcularCofins(s);
            this.CalcularIr(s);
            this.CalcularCsll(s);
            this.CalcularIssPagar(s);
        }
        //} else {
        //    this.CalcularPis(s)
        //    this.CalcularCofins(s)
        //    this.CalcularIr(s)
        //    this.CalcularInss(s)
        //    this.CalcularCsll(s)
        //    this.CalcularIssPagar(s)
        //}
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnValorDeducaoValidar = function () {
        this.CalcularBase();
    };
    C_NFSe.prototype.OnDescIncondicionado = function () {
        this.CalcularBase();
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnDescCondicionado = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnOutrasRetencoes = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnValorISSRetido = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnPis = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnCofins = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnIR = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnINSS = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnCSLL = function () {
        this.CalcularValorLiquido();
    };
    C_NFSe.prototype.OnPesquisouCodigoServico = function () {
        var parametros;
        var entidade = this.GetScope().Entity;
        this.hdnEmpresa.value = this.EntityTela.Empresa.toString();
        if (this.txtCodServico.GetText().CNum() <= 0) {
            this.LimparCamposServico(entidade);
        }
        else {
            parametros = {
                codigo: this.hdnEmpresa.value
            };
            var itens = this.ExecutarFuncaoServerSideSynch("RetornarServicosEmpresa", parametros);
            if (itens) {
                entidade.Cnae = itens[0].Cnae;
                entidade.Codservico = itens[0].CodServico;
                this.txtValAproxTrib.SetText("" + itens[0].Valor_Aprox_Tributos);
                parametros = {
                    descricao: itens[0].CodServico
                };
                var descricao = this.ExecutarFuncaoServerSideSynch("PesquisarPorDescricao", parametros);
                entidade.Descricaoatividade = descricao.Dados[0].Descricao;
            }
        }
        this.SetEntity(entidade);
        this.RefreshAngular();
    };
    C_NFSe.prototype.OnMudouComboEmpresa = function () {
        this.hdnEmpresa.value = this.EntityTela.Empresa.toString();
        this.OnDepoisLimpar(this.GetScope().Entity);
        this.PreencherComboServico();
    };
    C_NFSe.prototype.PreencherComboServico = function () {
        var parametros;
        if (this.cboServico && this.cboServico.Combo) {
            this.cboServico.ClearItems();
            parametros = {
                codigo: this.EntityTela.Empresa
            };
            var itens = this.ExecutarFuncaoServerSideSynch("RetornarServicosEmpresa", parametros);
            if (itens) {
                for (var x = 0; x < itens.length; x++) {
                    var msg = itens[x].CodServico + " / " + itens[x].Cnae;
                    this.cboServico.Combo.AddItem(msg, itens[x].CodServico, "");
                }
                this.cboServico.Combo.SetSelectedIndex(0);
            }
        }
    };
    C_NFSe.prototype.PreencherCamposProcuraServico = function () {
        var parametros;
        if (this.cboServico.GetItemCount() > 0) {
            parametros = {
                codigo: this.cboServico.Combo.GetSelectedIndex().valueOf()
            };
            var s = this.ExecutarFuncaoServerSideSynch("RetornarServicoPorCodigo", parametros);
            if (s) {
                //entity.DescAtividade = (New ServicoBO).PesquisarPorCodigo(s.CodServico).DescricaoAtividade        }
                //this.txtCodServico.Procurar(s.Id);
            }
        }
    };
    C_NFSe.prototype.OnPesquisouDados = function (s, e) {
        var parametros;
        var entidade = this.GetScope().Entity;
        if (!entidade.Codigocliente) {
            this.LimparCamposClientes(entidade);
            return false;
        }
        parametros = {
            codCliente: entidade.Codigocliente
        };
        var retorno = this.ExecutarFuncaoServerSideSynch("GetDadosCliente", parametros);
        parametros = {
            codigo: entidade.Numerorps,
            empresa: entidade.Empresa,
            serie: entidade.Serie
        };
        var nfse = this.ExecutarFuncaoServerSideSynch("ObterNumeroRps", parametros);
        if (retorno) {
            // this.MudouTipo(retorno.Tipo)
            entidade.Rg = retorno.Rg;
            entidade.Cpfcnpj = retorno.Cpf;
            entidade.Nomecliente = retorno.Nome;
            entidade.Endereco = retorno.Endereco_Nome;
            entidade.Bairro = retorno.Bairro;
            entidade.Numero = retorno.Numero;
            entidade.Complemento = retorno.Complemento;
            entidade.Cep = retorno.Cep;
            entidade.Cidade = retorno.Cidade_D;
            entidade.Ddd1 = retorno.Ddd1;
            entidade.Numero = retorno.Fone_Numero;
            if (retorno.Tipo = "F") {
                this.cboTipoTomador.SetSelectedIndex(2);
            }
            else {
                this.cboTipoTomador.SetSelectedIndex(1);
            }
            this.cboLocalOperacao.Combo.SetSelectedIndex(nfse.Localoperacao);
            if (nfse.CidadeOperacao) {
                this.txtCidadeOperacao.Procurar(nfse.Cidadeoperacao);
            }
        }
        if (nfse) {
            if (entidade.Codigocliente == nfse.Codigocliente) {
                entidade.Nomecliente = nfse.Nomecliente;
                entidade.Cpfcnpj = nfse.Cpfcnpj;
                entidade.Rg = nfse.Rg;
                entidade.Endereco = nfse.Endereco;
                entidade.Bairro = nfse.Bairro;
                entidade.Numero = nfse.Numero;
                entidade.Complemento = nfse.Complemento;
                entidade.Cep = nfse.Cep;
                entidade.Cidade = nfse.Cidade;
                entidade.Ddd1 = nfse.Ddd1;
                entidade.Telefone = nfse.Telefone;
                entidade.Codservico = nfse.Codservico;
                if (nfse.TipoTomador = "F") {
                    this.cboTipoTomador.SetSelectedIndex(2);
                }
                else {
                    this.cboTipoTomador.SetSelectedIndex(1);
                }
                this.cboLocalOperacao.Combo.SetSelectedIndex(nfse.Localoperacao);
                if (nfse.CidadeOperacao) {
                    this.txtCidadeOperacao.Procurar(nfse.Cidadeoperacao);
                }
            }
        }
        this.SetEntity(entidade);
        return false;
    };
    C_NFSe.prototype.OncboLocalOperacaoIndexChanged = function () {
        if (this.cboLocalOperacao.GetSelectedIndex() == 2) {
            //A alíquota do ISS é definida pela legislação municipal. Quando a NFS-e é tributada fora do município 
            //em que está sendo emitida, a alíquota será informada pelo contribuinte.
            //Fonte: http://sped.rfb.gov.br/pagina/show/488
            this.lblForaMun.Visible = true;
        }
        else {
            this.lblForaMun.Visible = false;
        }
    };
    C_NFSe.prototype.MudouTipo = function (tipo) {
        if (tipo == "J") {
            this.txtCpf.IsCPF = false;
        }
        else {
            this.txtCpf.IsCPF = true;
        }
    };
    C_NFSe.prototype.OnDigitouNumerorps = function () {
        this.OnMudouIdentificacao();
        return false;
    };
    C_NFSe.prototype.OnMudouIdentificacao = function () {
        var retorno;
        var parametros;
        var empresa = this.GetScope().Entity.Empresa;
        var serie = this.GetScope().Entity.Serie;
        var NumeroRps = this.GetScope().Entity.Numerorps;
        var permitirAlterarSequencia = this.ExecutarFuncaoServerSideSynch("ObterConfigAlterarSequencia", parametros);
        parametros = {
            codigo: NumeroRps,
            empresa: empresa,
            serie: serie
        };
        retorno = this.ExecutarFuncaoServerSideSynch("ObterNumeroRps", parametros);
        parametros = {
            empresa: empresa,
            serie: serie
        };
        var codigoGerado = this.ExecutarFuncaoServerSideSynch("PreencherNumeroNota", parametros);
        if (!retorno) {
            if (!permitirAlterarSequencia) {
                if (retorno == null) {
                    if (NumeroRps != codigoGerado) {
                        if (NumeroRps == 0) {
                            MostrarAlerta("Informe um valor de nota válido!");
                        }
                        else {
                            MostrarAlerta("Nota Fiscal não cadastrada!");
                        }
                    }
                    this.OnDepoisLimpar(this.GetScope().Entity);
                }
            }
            else {
                if (NumeroRps > codigoGerado) {
                    MsgBoxJS("O Código da última nota é " + codigoGerado + ", o código que está inserindo não está na sequência, deseja continuar?", MsgBoxOptions.YesNo, MsgBoxIcon.Question, $.proxy(this.RespostaSequencia, this));
                }
                else {
                    retorno = {};
                    retorno.Empresa = empresa;
                    retorno.Serie = serie;
                    retorno.NumeroRps = NumeroRps;
                    parametros = {
                        descricao: retorno.CodServico
                    };
                    var descricao = this.ExecutarFuncaoServerSideSynch("PesquisarPorDescricao", parametros);
                    retorno.Codservico = descricao.Dados[0].Codigo;
                    this.GetScope().Entity = retorno;
                }
                this.OnDepoisLimpar(this.GetScope().Entity);
                this.retornaNumeracao();
            }
        }
        else {
            this.hdnCodigo.value = retorno.Codigo.toString();
            this.GetScope().Entity = retorno;
            //parametros = {
            //    CodigoNF: retorno.Codigo
            //}
            //    this.EventosNFe = this.ExecutarFuncaoServerSideSynch("PreencherClasseEventosNFe", parametros);
            //    this.hdnCodigo.value = retorno.Codigo.toString();
            //    this.CalcularTotalNota();
            //    this.GetScope().Entity = retorno;
            //    this.NFe = retorno.NFe[0];
            //}
        }
        this.GetScope().$applyAsync();
        if (NumeroRps == 0) {
            this.retornaNumeracao();
        }
    };
    C_NFSe.prototype.retornaNumeracao = function () {
        var novaNF = this.GetScope().Entity;
        var serie = novaNF.Serie;
        var empresa = novaNF.Empresa;
        var parametros;
        parametros = {
            empresa: empresa,
            serie: serie
        };
        novaNF.Numerorps = this.ExecutarFuncaoServerSideSynch("PreencherNumeroNota", parametros);
        this.GetScope().Entity.Numerorps = novaNF.Numerorps;
    };
    C_NFSe.prototype.RespostaSequencia = function (result) {
        if (result.Resultado == MsgBoxResult.No) {
            this.retornaNumeracao();
        }
        else {
            var novaNF = this.GetScope().Entity;
            var serie = novaNF.Serie;
            var empresa = novaNF.Empresa;
            novaNF = {};
            novaNF.Serie = serie;
            novaNF.Empresa = empresa;
            novaNF.Numerorps = this.EntityTela.Numerorps;
            this.GetScope().$applyAsync();
        }
    };
    C_NFSe.prototype.OnMudouComboSerie = function (s, e) {
        this.hdnSeriePadrao.value = this.GetScope().Entity.Serie.toString();
        this.OnDepoisLimpar(this.GetScope().Entity);
    };
    C_NFSe.prototype.OnClickBotaoMais = function () {
        this.EntityTela.Numerorps += 1;
        this.GetScope().$applyAsync();
        //return false;
    };
    C_NFSe.prototype.OnClickBotaoMenos = function () {
        var num;
        //num = this.GetScope().Entity.Numerorps - 1;
        num = this.EntityTela.Numerorps - 1;
        if (num == 0) {
            num = 1;
        }
        //this.GetScope().Entity.Numerorps = num;
        this.EntityTela.Numerorps = num;
        this.RefreshAngular();
        //this.GetScope().$applyAsync();
        //return false;
    };
    C_NFSe.prototype.OnDepoisLimpar = function (Entity) {
        var parametros;
        var retorno;
        var serie;
        if (!Entity.Empresa) {
            Entity.Empresa = ValoresSismoura.EmpresaPadraoUsuario;
        }
        if (this.hdnSeriePadrao.value.CNum() > 0) {
            serie = this.hdnSeriePadrao.value.CNum();
        }
        else {
            serie = Entity.Serie;
        }
        parametros = {
            empresa: Entity.Empresa,
            serie: serie
        };
        retorno = this.ExecutarFuncaoServerSideSynch("PreencherNumeroNota", parametros);
        Entity.Numerorps = retorno;
        Entity.Serie = serie;
        Entity.Numeronfse = undefined;
        Entity.Localoperacao = undefined;
        Entity.Cidadeoperacao = undefined;
        Entity.Aliquotaservico = undefined;
        this.txtCodServico.SetText("");
        Entity.Codservico = "";
        Entity.Descricaoservico = "";
        Entity.Codart = "";
        Entity.Codobra = "";
        Entity.Valor = undefined;
        Entity.Valordeducao = undefined;
        Entity.Descincondicionado = undefined;
        Entity.Desccondicionado = undefined;
        Entity.Outrasretencoes = undefined;
        Entity.Issretido = undefined;
        Entity.Valorissretido = undefined;
        Entity.Pis = undefined;
        Entity.Cofins = undefined;
        Entity.Ir = undefined;
        Entity.Inss = undefined;
        Entity.Csll = undefined;
        Entity.Basecalculo = undefined;
        Entity.Valorliquido = undefined;
        Entity.Isspagar = undefined;
        Entity.Protocolo = "";
        Entity.Xmlgerado = undefined;
        Entity.Situacaolote = undefined;
        Entity.Cnae = "";
        Entity.Codverificacaonfse = "";
        Entity.Descricaoatividade = "";
        Entity.Protocolo_Saovicente = "";
        Entity.Venda = undefined;
        Entity.Tipo_Importacao = undefined;
        Entity.Cancelado = "";
        Entity.Cod_Tributacao = undefined;
        Entity.Im_Tomador = "";
        Entity.Ambiente = undefined;
        this.LimparCamposClientes(Entity);
        this.LimparCamposServico(Entity);
        this.RefreshAngular();
        //return true;
    };
    C_NFSe.prototype.LimparCamposClientes = function (entidade) {
        entidade.Codigocliente = null;
        entidade.Nomecliente = "";
        entidade.Endereco = "";
        entidade.Bairro = "";
        entidade.Numero = "";
        entidade.Complemento = "";
        entidade.Cep = "";
        entidade.Cpfcnpj = "";
        entidade.Rg = "";
        entidade.Cidade = null;
        entidade.Ddd1 = null;
        entidade.Telefone = null;
        entidade.Email = "";
        this.cboTipoTomador.SetSelectedIndex(0);
    };
    C_NFSe.prototype.LimparCamposServico = function (entidade) {
        entidade.Descricaoservico = "";
        entidade.Descricaoatividade = "";
        entidade.Cnae = "";
        entidade.Aliquotaservico = null;
        //entidade.Valor = "";
        this.RefreshAngular();
    };
    return C_NFSe;
}(MouraPageCadastroAngular));
var c_NFSe = new C_NFSe();
//# sourceMappingURL=C_NFSe.js.map